{"version":3,"file":"IBKRConnection.js","sourceRoot":"","sources":["../../src/connection/IBKRConnection.ts"],"names":[],"mappings":"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","sourcesContent":["import { Subscription } from \"rxjs\";\nimport { IBApiNextCreationOptions, IBApiNext, ConnectionState } from \"@stoqey/ib\"\nimport { log } from \"../utils/log\";\nimport Portfolios from \"../portfolios/Portfolios\";\nimport Orders from \"../orders/Orders\";\nimport MarketDataManager from \"../marketdata/MarketDataManager\";\nimport { IBKREvents, IBKREVENTS } from \"../events\";\nimport { AccountSummary } from \"../account/AccountSummary\";\n\nconst ibkrEvents = IBKREvents.Instance;\n\nexport class IBKRConnection {\n\n    private ibApiNext: IBApiNext;\n\n    connected: boolean = false;\n    private connection: Subscription;\n    private errors: Subscription;\n    private connectionState: ConnectionState;\n\n    private static _instance: IBKRConnection;\n\n    public static get Instance(): IBKRConnection {\n        return this._instance || (this._instance = new this());\n    }\n\n    constructor() { }\n\n    get ib(): IBApiNext {\n        return this.ibApiNext;\n    };\n\n    /**\n     * initializeDep\n     * Call/Initialize Account summary -> Portfolios -> OpenOrders\n     */\n    public initializeDep = async (): Promise<boolean> => {\n        try {\n            // 1. Account summary\n            log('1. Account summary');\n            const accountSummary = AccountSummary.Instance;\n            accountSummary.init();\n            await accountSummary.getAccountSummaryUpdates();\n            // 2. Market data\n            log('2. Market data');\n            const marketData = MarketDataManager.Instance;\n            await marketData.init();\n            // 3. Portfolios\n            log('3. Portfolios');\n            const portfolio = Portfolios.Instance;\n            await portfolio.init();\n            await portfolio.asyncPortfolios();\n            // 4. Orders\n            log('3. Orders');\n            const openOrders = Orders.Instance;\n            await openOrders.init();\n            await openOrders.asyncOpenOrders();\n\n            return true;\n        } catch (error) {\n            log('error initialising IBKR', error);\n            return false;\n        }\n    };\n\n\n\n    public init(opt?: Partial<IBApiNextCreationOptions>): Promise<boolean> {\n            if (this.connected || this.ibApiNext) {\n                log('already init');\n                return Promise.resolve(true);\n            }\n            if (opt) {\n                if (!opt.reconnectInterval) opt.reconnectInterval = 1000;\n                if (!opt.connectionWatchdogInterval) opt.connectionWatchdogInterval = 1;\n                log('init with options', opt);\n                this.ibApiNext = new IBApiNext(opt);\n            } else {\n                opt = {};\n                // reconnect interval from env\n                opt.reconnectInterval = parseInt(process.env.IBKR_RECONNECT_INTERVAL) || 1000;\n                opt.connectionWatchdogInterval = parseInt(process.env.IBKR_WATCHDOG_INTERVAL) || 1;\n\n                // port and host from env\n                opt.host = process.env.IBKR_HOST || '127.0.0.1';\n                opt.port = parseInt(process.env.IBKR_PORT) || 7497;\n                log('init with env', opt);\n                this.ibApiNext = new IBApiNext(opt);\n            }\n\n            this.ibApiNext.logLevel = 5;\n\n            return this.connect();\n    }\n\n    async connect(clientId: number = 0): Promise<boolean> {\n\n        if (process.env.IBKR_CLIENT_ID) {\n            clientId = parseInt(process.env.IBKR_CLIENT_ID);\n        };\n\n        return new Promise((resolve) => {\n            // connect to IBKR\n            if (this.connected) {\n                this.initializeDep();\n                resolve(true);\n            }\n            this.errors = this.ibApiNext.errorSubject.subscribe((error: any) => {\n                log(\"IBKRConnection.ibApiNext.errors\", error.message)\n            })\n\n            this.ibApiNext.connectionState.subscribe((state) => {\n                log('connection state', state);\n                switch (state) {\n                    case ConnectionState.Connecting:\n                        this.connectionState = state;\n                        log('connecting to ibkr');\n                        break;\n                    case ConnectionState.Connected:\n                        this.connectionState = state;\n                        this.connected = true;\n                        log('connected to ibkr');\n                        resolve(true);\n                        break;\n                    case ConnectionState.Disconnected:\n                        log('disconnected from ibkr', this.connectionState);\n                        this.connected = false;\n                        if (this.connectionState === ConnectionState.Connecting) {\n                            this.connectionState = state;\n                            // if was connecting, then reject\n                            resolve(false);\n                        }\n                        break;\n                    default:\n                        break;\n                }\n            });\n\n            if (!this.connection) {\n                this.connection = this.ibApiNext.connectionState.subscribe((state) => {\n                    log('connection state', state);\n                    switch (state) {\n                        case ConnectionState.Connecting:\n                            this.connectionState = state;\n                            log('connecting to ibkr');\n                            break;\n                        case ConnectionState.Connected:\n                            this.connectionState = state;\n                            this.connected = true;\n                            this.initializeDep();\n                            ibkrEvents.emit(IBKREVENTS.IBKR_CONNECTED);\n                            log('connected to ibkr');\n                            break;\n                        case ConnectionState.Disconnected:\n                            log('disconnected from ibkr', this.connectionState);\n                            this.connected = false;\n\n                            // TODO disconnect\n                            if (this.connectionState === ConnectionState.Connecting) {\n                                this.connectionState = state;\n                            }\n\n                            if (this.connectionState === ConnectionState.Disconnected) {\n                                // process.exit(0);\n                                console.log('ConnectionState.Disconnected', ConnectionState.Disconnected);\n                            }\n\n                            break;\n                        default:\n                            break;\n                    }\n                });\n            }\n\n\n            this.ibApiNext.connect(clientId);\n\n        });\n\n    }\n\n    disconnect() {\n        // TODO others....\n        if (this.connection) {\n            this.connection.unsubscribe();\n        }\n    }\n}\n\nexport default IBKRConnection;"]}