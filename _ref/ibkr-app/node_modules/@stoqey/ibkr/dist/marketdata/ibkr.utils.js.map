{"version":3,"file":"ibkr.utils.js","sourceRoot":"","sources":["../../src/marketdata/ibkr.utils.ts"],"names":[],"mappings":"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","sourcesContent":["import isEmpty from 'lodash/isEmpty';\nimport moment from 'moment';\nimport differenceBy from 'lodash/differenceBy';\nimport uniqBy from 'lodash/uniqBy';\nimport { WhatToShow, SecType, BarSizeSetting, Bar } from '@stoqey/ib';\nimport { log, delay} from '../utils';\nimport { MarketData } from '../interfaces';\nimport MarketDataManager from './MarketDataManager';\nimport { GetHistoricalData, getSymbolKey } from '../utils/instrument.utils';\n\n/**\n * IBKR Utils \n * separate from db, and other modules/business logic\n */\n\nconst throttleDelay = 500;\n\nexport const getHistoricalData = async (opt: GetHistoricalData): Promise<MarketData[]> => {\n    const { instrument, startDate, endDate, whatToShow } = opt;\n    const saveToDb = opt?.saveToDb;\n\n    const save = async (mkd: MarketData[]): Promise<void> => {\n        if (saveToDb) {\n            await saveToDb(mkd);\n            return;\n        }\n    };\n\n    if (!endDate) {\n        const singleDayMkd = await getSecondsHistoricalDataFromIb(instrument, startDate, whatToShow);\n        await save(singleDayMkd);\n\n        return singleDayMkd;\n    } else {\n        // loop through days\n        let dayDate = new Date(startDate);\n        let endDateLoop = new Date(endDate);\n        let data: MarketData[] = [];\n        while (dayDate <= endDateLoop) {\n            const dayData = await getSecondsHistoricalDataFromIb(instrument, dayDate, whatToShow);\n            if (isEmpty(dayData)) {\n                dayDate.setDate(dayDate.getDate() + 1);\n                continue;\n            }\n            await save(dayData);\n            data = data.concat(dayData);\n            dayDate.setDate(dayDate.getDate() + 1);\n        }\n        return data;\n    }\n};\n\n\nexport async function getSecondsHistoricalDataFromIb(\n    symbol: string | Object,\n    dayDate: Date,\n    whatToShow: WhatToShow = WhatToShow.ASK\n): Promise<MarketData[]> {\n\n    let fetchedData: MarketData[] = [];\n    let prev = null;\n\n    try {\n\n        const marketDataManager = MarketDataManager.Instance;\n        let contract: any = symbol;\n\n        if (typeof symbol === 'string') {\n            contract = await marketDataManager.getContract({ symbol, secType: SecType.STK, exchange: 'SMART', currency: 'USD' });\n        }\n\n        // Default to 8 - 5:30\n        let date = new Date(dayDate.getFullYear(), dayDate.getMonth(), dayDate.getDate(), 17, 30, 0); // set date to 5:30 when market closes\n        let count = 10; // 10 hours back\n\n        if (contract?.secType === SecType.FUT) {\n            // futures e.t.c ...\n            date = new Date(dayDate.getFullYear(), dayDate.getMonth(), dayDate.getDate(), 23, 59, 0);\n            count = 23; // 23 hours back\n        }\n\n        const resolve = (): MarketData[] => {\n            if (isEmpty(fetchedData)) {\n                return [];\n            }\n            const sorted = uniqBy(fetchedData, 'date').sort((a: Bar, b: Bar) => {\n                if (new Date(a.time) > new Date(b.time)) {\n                    return 1;\n                }\n                return -1;\n            });\n\n            return sorted;\n        };\n\n        const symbolKey = getSymbolKey(contract);\n        for (const x of new Array(count).fill('x')) {\n            date = new Date(date.setHours(date.getHours() - 1));\n            const endDateTime = moment(date).format('yyyyMMDD-HH:mm:ss');\n            log(`ibApi.reqHistoricalData -----> ${symbolKey}`, endDateTime);\n\n            const timeout = 1000 * 50; // 50 seconds\n\n            const timeoutPromise = new Promise((resolve, reject) => {\n                setTimeout(() => {\n                    resolve([]);\n                }, timeout);\n            });\n\n            const marketData = await Promise.race([\n                marketDataManager.getHistoricalData(\n                    contract,\n                    endDateTime,\n                    '3600 S',\n                    BarSizeSetting.SECONDS_FIVE,\n                    whatToShow\n                ),\n                timeoutPromise\n            ]) as MarketData[];\n\n            if (!marketData || marketData?.length === 0) {\n                log('ibApi.reqHistoricalData -----> no data fetched', `${symbolKey} ${JSON.stringify(marketData)}`);\n                break;\n            }\n\n            log('ibApi.reqHistoricalData -----> fetched', `${symbolKey} ${marketData && marketData.length}`);\n            fetchedData = [...fetchedData, ...marketData];\n\n            await delay(throttleDelay, count);\n\n            if (prev) {\n                const differences = differenceBy(prev, marketData, 'date');\n                const duplicates = isEmpty(differences);\n\n                if (duplicates) {\n                    log('ibApi.reqHistoricalData -----> duplicates', `${symbolKey} ${marketData && marketData.length}`);\n                    count = 0;\n                    break;\n                }\n            }\n\n            prev = marketData; // record prev\n            --count; // decrease count\n        }\n\n        return resolve();\n    } catch (error) {\n        log('error getting round trip market data', error);\n        return [];\n    }\n};"]}