{"version":3,"file":"MarketDataManager.js","sourceRoot":"","sources":["../../src/marketdata/MarketDataManager.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,kDAA4B;AAC5B,6BAAmE;AACnE,gFAA0D;AAC1D,iCAAkH;AAElH,2DAAqC;AAErC,oCAAyC;AACzC,oCAAmD;AACnD,wEAAkD;AAClD,2DAAqC;AACrC,kDAAoD;AACpD,8DAAyD;AACzD,kDAAgD;AAChD,wCAA4C;AAC5C,yDAAmC;AACnC,kCAAkC;AAElC,6BAAmC;AAEnC,IAAM,SAAS,GAAG,mBAAU,CAAC,QAAQ,CAAC;AAMtC,IAAM,SAAS,GAAG,QAAQ,CAAC;AAa3B;IAAuC,qCAAU;IA6a7C;QACI,YAAA,MAAK,WAAE,SAAC;QA7aZ,eAAS,GAAG,SAAS,CAAC;QAGd,8BAAwB,GAA8B,IAAI,GAAG,EAAE,CAAC;QAChE,8BAAwB,GAA8B,IAAI,GAAG,EAAE,CAAC;QAEhE,oBAAc,GAAgC,IAAI,GAAG,EAAE,CAAC;QACxD,wBAAkB,GAAgC,IAAI,GAAG,EAAE,CAAC;QASpE,iCAA2B,GAAG,UAAC,QAAkB;YAC7C,IAAM,QAAQ,GAAG,KAAI,CAAC,YAAY,CAAC,QAAQ,CAAC,CAAC;YAC7C,IAAM,YAAY,GAAG,KAAI,CAAC,wBAAwB,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;YACjE,IAAI,YAAY,EAAE,CAAC;gBACf,YAAY,CAAC,WAAW,EAAE,CAAC;gBAC3B,KAAI,CAAC,wBAAwB,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;YACnD,CAAC;YACD,KAAI,CAAC,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;QACzC,CAAC,CAAC;QAGF,8BAAwB,GAAG,UAAO,QAAkB,EAAE,cAA8B,EAAE,UAAsB;;;;;;;wBAG9F,sBAAoB,oBAAU,CAAC,QAAQ,CAAC;6BAE1C,CAAA,CAAC,QAAQ,CAAC,KAAK,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAA,EAArC,wBAAqC;wBAC1B,qBAAM,IAAI,CAAC,WAAW,CAAC,QAAoB,CAAC,EAAA;;wBAAvD,QAAQ,GAAG,SAA4C,CAAC;;;wBAEtD,aAAW,IAAI,CAAC,YAAY,CAAC,QAAQ,CAAC,CAAC;wBAE7C,IAAI,IAAI,CAAC,wBAAwB,CAAC,GAAG,CAAC,UAAQ,CAAC,EAAE,CAAC;4BAC9C,IAAA,UAAI,EAAC,UAAG,SAAS,8BAA2B,EAAE,gCAAyB,UAAQ,CAAE,CAAC,CAAC;4BACnF,sBAAO;wBACX,CAAC;wBAEK,0BAA0B,GAAG;;;;;;wCAC/B,IAAA,SAAG,EAAC,UAAG,SAAS,yDAAsD,EAAE,UAAG,UAAQ,CAAE,CAAC,CAAC;wCACjF,WAAW,GAAG,IAAA,gBAAM,GAAE,CAAC,MAAM,CAAC,mBAAmB,CAAC,CAAC;wCACnD,WAAW,GAAG,QAAQ,CAAC;wCACvB,kBAAkB,GAAG,QAAQ,CAAC;wCACX,qBAAM,IAAA,gBAAM,EAAC,IAAI,CAAC,iBAAiB,CAAC,QAAQ,EAAE,WAAW,EAAE,WAAW,EAAE,kBAAoC,EAAE,UAAU,CAAC,CAAC,EAAA;;wCAA5I,cAAc,GAAI,CAAA,SAA0H,CAAA,GAA9H;wCAErB,IAAI,CAAC,IAAA,iBAAO,EAAC,cAAc,CAAC,EAAE,CAAC;4CACrB,KAAK,GAAG,cAAc,IAAI,cAAc,CAAC,CAAC,CAAC,CAAC;4CAC5C,IAAI,GAAG,CAAC,cAAc,IAAI,EAAE,CAAC,CAAC,cAAc,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;4CAE/D,IAAA,kBAAU,EAAC,cAAc,CAAC,CAAC;4CAE3B,IAAA,SAAG,EAAC,UAAG,SAAS,gEAA6D,EAAE,UAAG,cAAc,aAAd,cAAc,uBAAd,cAAc,CAAE,MAAM,8BAAoB,UAAQ,mBAAS,IAAA,0BAAa,EAAC,KAAK,aAAL,KAAK,uBAAL,KAAK,CAAE,IAAI,CAAC,iBAAO,IAAA,0BAAa,EAAC,IAAI,aAAJ,IAAI,uBAAJ,IAAI,CAAE,IAAI,CAAC,eAAK,IAAA,sBAAS,EAAC,KAAK,aAAL,KAAK,uBAAL,KAAK,CAAE,KAAK,CAAC,kBAAQ,IAAA,sBAAS,EAAC,IAAI,aAAJ,IAAI,uBAAJ,IAAI,CAAE,KAAK,CAAC,yBAAe,UAAU,CAAE,CAAC,CAAC;4CAC9R,cAAc,CAAC,OAAO,CAAC,UAAC,cAAc;gDAClC,KAAI,CAAC,QAAQ,CAAC,cAAc,CAAC,CAAC;4CAClC,CAAC,CAAC,CAAC;4CACG,cAAc,GAAG,cAAc,CAAC,cAAc,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;4CACjE,IAAI,cAAc,EAAE,CAAC;gDACjB,mBAAiB,CAAC,iBAAiB,CAAC,QAAQ,CAAC,KAAK,EAAE,cAAc,CAAC,KAAK,CAAC,CAAC;4CAC9E,CAAC;wCACL,CAAC;;;;6BACJ,CAAA;wBAED,qBAAM,0BAA0B,EAAE,EAAA;;wBAAlC,SAAkC,CAAC;wBAEnC,IAAA,SAAG,EAAC,UAAG,SAAS,8BAA2B,EAAE,yBAAkB,UAAQ,CAAE,CAAC,CAAC;wBAC3E,IAAI,CAAC,wBAAwB,CAAC,GAAG,CAAC,UAAQ,EAAE,wBAAc,CAAC,QAAQ,CAAC,EAAE,CAAC,wBAAwB,CAAC,QAAQ,EAAE,cAAc,EAAE,UAAU,EAAE,CAAC,CAAC;6BACnI,IAAI,CACD,IAAA,iBAAU,EAAC,UAAC,KAAK;4BACb,IAAA,UAAI,EAAC,UAAG,SAAS,8BAA2B,EAAE,+BAAwB,UAAQ,CAAE,EAAE,KAAK,CAAC,CAAC;4BACzF,KAAI,CAAC,wBAAwB,CAAC,MAAM,CAAC,UAAQ,CAAC,CAAC;4BAC/C,OAAO,IAAA,SAAE,EAAC,IAAI,CAAC,CAAC;wBACpB,CAAC,CAAC,CACL;6BACA,SAAS,CAAC,UAAC,GAAG;4BACX,IAAI,CAAC,GAAG;gCAAE,OAAO;4BACjB,IAAM,WAAW,GAAG,IAAI,IAAI,EAAE,CAAC,CAAC,oDAAoD;4BACpF,IAAM,OAAO,GAAG,CAAC,GAAG,CAAC,IAAI,GAAG,IAAI,CAAC,CAAC,uBAAuB;4BACzD,IAAM,SAAS,GAAG,IAAI,IAAI,CAAC,WAAW,CAAC,CAAC,UAAU,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,2EAA2E;4BACrI,IAAM,WAAW,GAAG,KAAI,CAAC,cAAc,CAAC,GAAG,CAAC,UAAQ,CAAC,CAAC;4BAEtD,IAAI,iBAAiB,GAAG,GAAG,CAAC,MAAM,CAAC;4BAEnC,IAAI,WAAW,IAAI,CAAA,WAAW,aAAX,WAAW,uBAAX,WAAW,CAAE,SAAS,MAAK,SAAS,EAAE,CAAC;gCACtD,iBAAiB,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,GAAG,CAAC,MAAM,GAAG,WAAW,CAAC,gBAAgB,CAAC,CAAC;4BAC/E,CAAC;4BAED,KAAI,CAAC,cAAc,CAAC,GAAG,CAAC,UAAQ,EAAE;gCAC9B,OAAO,EAAE,OAAO;gCAChB,gBAAgB,EAAE,GAAG,CAAC,MAAM;gCAC5B,SAAS,WAAA;6BACZ,CAAC,CAAC;4BAEH,IAAM,cAAc,GAAe;gCAC/B,UAAU,EAAE,QAAsB;gCAClC,IAAI,EAAE,WAAW,EAAE,uCAAuC;gCAC1D,IAAI,EAAE,GAAG,CAAC,IAAI;gCACd,IAAI,EAAE,GAAG,CAAC,IAAI;gCACd,GAAG,EAAE,GAAG,CAAC,GAAG;gCACZ,KAAK,EAAE,GAAG,CAAC,KAAK;gCAChB,MAAM,EAAE,iBAAiB,EAAE,yBAAyB;gCACpD,GAAG,EAAE,GAAG,CAAC,GAAG;gCACZ,IAAI,EAAE,GAAG,CAAC,GAAG;gCACb,KAAK,EAAE,GAAG,aAAH,GAAG,uBAAH,GAAG,CAAE,KAAK;6BACpB,CAAC;4BAEF,KAAI,CAAC,QAAQ,CAAC,cAAc,CAAC,CAAC;4BAG9B,IAAI,GAAG,aAAH,GAAG,uBAAH,GAAG,CAAE,KAAK,EAAE,CAAC;gCACb,mBAAiB,CAAC,iBAAiB,CAAC,QAAQ,CAAC,KAAK,EAAE,GAAG,CAAC,KAAK,CAAC,CAAC;4BACnE,CAAC;4BAED,SAAS,CAAC,IAAI,CAAC,mBAAU,CAAC,QAAQ,EAAE,cAAc,CAAC,CAAC;4BAEpD,IAAM,SAAS,GAAG,iBAAiB,GAAG,CAAC,CAAC,CAAC,CAAC,cAAO,iBAAiB,CAAE,CAAC,CAAC,CAAC,EAAE,CAAC;4BAC1E,IAAM,aAAa,GAAG,GAAG,CAAC,MAAM,KAAK,iBAAiB,CAAC,CAAC,CAAC,iBAAU,GAAG,CAAC,MAAM,CAAE,CAAC,CAAC,CAAC,EAAE,CAAC;4BACrF,IAAM,QAAQ,GAAG,CAAC,WAAW,IAAI,WAAW,CAAC,SAAS,KAAK,SAAS,CAAC;4BACrE,IAAM,SAAS,GAAG,QAAQ,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC;4BAC/C,IAAA,SAAG,EAAC,UAAG,SAAS,SAAM,EAAE,kBAAW,UAAQ,iBAAO,IAAA,0BAAa,EAAC,WAAW,CAAC,eAAK,GAAG,CAAC,KAAK,cAAI,SAAS,cAAI,aAAa,cAAI,SAAS,CAAE,CAAC,IAAI,EAAE,CAAC,CAAC;wBACpJ,CAAC,CAAC,CAAC,CAAC;;;;wBAGR,IAAA,UAAI,EAAC,gCAAgC,EAAE,GAAC,CAAC,CAAC;wBAC1C,sBAAO;;;;aAEd,CAAA;QAGD,uBAAiB,GAAG;;;;;+JAAO,QAAkB,EAAE,WAA+B,EAAE,WAAmB,EAAE,cAA8B,EAAE,UAAsB,EAAE,MAAc;;gBAAd,uBAAA,EAAA,cAAc;;;gCAC7H,qBAAM,IAAA,gBAAM,EAAC,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC,EAAA;;4BAA5E,KAAoC,SAAwC,EAA3E,kBAAkB,QAAA,EAAE,WAAW,QAAA;4BACtC,IAAI,WAAW,EAAE,CAAC;gCACd,IAAA,UAAI,EAAC,gCAAgC,EAAE,WAAW,CAAC,CAAC;gCACpD,sBAAO,IAAI,EAAC;4BAChB,CAAC;4BACD,IAAI,CAAC,kBAAkB,EAAE,CAAC;gCACtB,IAAA,UAAI,EAAC,sCAAsC,EAAE,QAAQ,CAAC,CAAC;gCACvD,sBAAO,IAAI,EAAC;4BAChB,CAAC;4BAEK,MAAM,GAAG,IAAI,CAAC,YAAY,CAAC,kBAAkB,CAAC,CAAC;4BACjC,qBAAM,IAAA,gBAAM,EAAC,wBAAc,CAAC,QAAQ,CAAC,EAAE,CAAC,iBAAiB,CAAC,kBAAkB,EAAE,WAAW,EAAE,WAAW,EAAE,cAAc,EAAE,UAAU,EAAE,MAAM,EAAE,CAAC,CAAC,CAAC,EAAA;;4BAA7J,KAAc,SAA+I,EAA5J,IAAI,QAAA,EAAE,GAAG,QAAA;4BAChB,IAAI,IAAI,IAAI,IAAI,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gCACpB,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,UAAA,GAAG;oCACpB,IAAM,IAAI,GAAG,IAAI,IAAI,CAAC,CAAC,GAAG,CAAC,IAAI,GAAG,IAAI,CAAC,CAAC;oCACxC,IAAM,cAAc,GAAe;wCAC/B,UAAU,EAAE,kBAAkB,aAAlB,kBAAkB,uBAAlB,kBAAkB,CAAE,QAAsB;wCACtD,IAAI,MAAA;wCACJ,IAAI,EAAE,GAAG,CAAC,IAAI;wCACd,IAAI,EAAE,GAAG,CAAC,IAAI;wCACd,GAAG,EAAE,GAAG,CAAC,GAAG;wCACZ,KAAK,EAAE,GAAG,CAAC,KAAK;wCAChB,MAAM,EAAE,GAAG,CAAC,MAAM;wCAClB,GAAG,EAAE,GAAG,CAAC,GAAG;wCACZ,IAAI,EAAE,GAAG,CAAC,GAAG,EAAE,cAAc;wCAC7B,KAAK,EAAE,GAAG,aAAH,GAAG,uBAAH,GAAG,CAAE,KAAK;qCACpB,CAAC;oCACF,OAAO,cAAc,CAAC;gCAC1B,CAAC,CAAC,CAAC;gCAEH,sBAAO,IAAA,gBAAM,EAAC,GAAG,EAAE,MAAM,CAAC,EAAC;4BAC/B,CAAC;4BACD,IAAI,GAAG,EAAE,CAAC;gCACN,IAAA,UAAI,EAAC,gCAAyB,MAAM,CAAE,EAAE,GAAG,CAAC,CAAC;4BACjD,CAAC;4BACD,sBAAO,IAAI,EAAC;;;;SACf,CAAC;QAEF,4BAAsB,GAAG;;;;;yHAAO,QAAkB,EAAE,SAAwB,EAAE,OAAuB,EAAE,aAAoB,EAAE,MAAc;;gBAApC,8BAAA,EAAA,oBAAoB;gBAAE,uBAAA,EAAA,cAAc;;;;4BACvI,IAAI,CAAC,SAAS,EAAE,CAAC;gCACb,IAAA,UAAI,EAAC,0CAA0C,CAAC,CAAC;gCACjD,sBAAO,IAAI,EAAC;4BAChB,CAAC;4BAED,IAAI,OAAO,IAAI,SAAS,GAAG,OAAO,EAAE,CAAC;gCACjC,IAAA,UAAI,EAAC,+DAA+D,CAAC,CAAC;gCACtE,sBAAO,IAAI,EAAC;4BAChB,CAAC;4BAEK,aAAa,GAAG,OAAO,SAAS,KAAK,QAAQ,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,IAAA,gBAAM,EAAC,SAAS,CAAC,CAAC,MAAM,CAAC,mBAAmB,CAAC,CAAC;4BAC1G,WAAW,GAAG,OAAO,OAAO,KAAK,QAAQ,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,IAAA,gBAAM,EAAC,OAAO,CAAC,CAAC,MAAM,CAAC,mBAAmB,CAAC,CAAC;4BAE9D,qBAAM,IAAA,gBAAM,EAAC,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC,EAAA;;4BAA5E,KAAoC,SAAwC,EAA3E,kBAAkB,QAAA,EAAE,WAAW,QAAA;4BACtC,IAAI,WAAW,EAAE,CAAC;gCACd,IAAA,UAAI,EAAC,qCAAqC,EAAE,WAAW,CAAC,CAAC;gCACzD,sBAAO,IAAI,EAAC;4BAChB,CAAC;4BACD,IAAI,CAAC,kBAAkB,EAAE,CAAC;gCACtB,IAAA,UAAI,EAAC,2CAA2C,EAAE,QAAQ,CAAC,CAAC;gCAC5D,sBAAO,IAAI,EAAC;4BAChB,CAAC;4BAEK,MAAM,GAAG,IAAI,CAAC,YAAY,CAAC,kBAAkB,CAAC,CAAC;4BAEhC,qBAAM,IAAA,gBAAM,EAAC,IAAA,oBAAa,EAC3C,wBAAc,CAAC,QAAQ,CAAC,EAAE,CAAC,sBAAsB,CAC7C,kBAAkB,EAClB,aAAa,EACb,WAAW,EACX,aAAa,EACb,MAAM,CACT,CACJ,CAAC,EAAA;;4BARI,KAAe,SAQnB,EARK,KAAK,QAAA,EAAE,GAAG,QAAA;4BAUjB,IAAI,KAAK,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gCACtB,GAAG,GAAG,KAAK,CAAC,GAAG,CAAC,UAAA,GAAG;oCACrB,IAAM,IAAI,GAAG,IAAI,IAAI,CAAC,CAAC,GAAG,CAAC,IAAI,GAAG,IAAI,CAAC,CAAC;oCACxC,IAAM,YAAY,GAAsB;wCACpC,QAAQ,EAAE,kBAAkB,aAAlB,kBAAkB,uBAAlB,kBAAkB,CAAE,QAAoB;wCAClD,IAAI,MAAA;wCACJ,KAAK,EAAE,GAAG,CAAC,KAAK;wCAChB,IAAI,EAAE,GAAG,CAAC,IAAI;wCACd,QAAQ,EAAE,GAAG,CAAC,QAAQ;wCACtB,iBAAiB,EAAE,GAAG,CAAC,iBAAiB;qCAC3C,CAAC;oCACF,OAAO,YAAY,CAAC;gCACxB,CAAC,CAAC,CAAC;gCAEH,sBAAO,IAAA,gBAAM,EAAC,GAAG,EAAE,MAAM,CAAC,EAAC;4BAC/B,CAAC;4BACD,IAAI,GAAG,EAAE,CAAC;gCACN,IAAA,UAAI,EAAC,qCAA8B,MAAM,CAAE,EAAE,GAAG,CAAC,CAAC;4BACtD,CAAC;4BACD,sBAAO,IAAI,EAAC;;;;SACf,CAAC;QAEF,8BAAwB,GAAG,UAAO,QAAkB;;;;;;;wBAEtC,sBAAoB,oBAAU,CAAC,QAAQ,CAAC;6BAE1C,CAAA,CAAC,QAAQ,CAAC,KAAK,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAA,EAArC,wBAAqC;wBACT,qBAAM,IAAI,CAAC,WAAW,CAAC,QAAoB,CAAC,EAAA;;wBAAlE,kBAAkB,GAAG,CAAC,SAA4C,CAAC;wBACzE,IAAI,CAAC,kBAAkB,EAAE,CAAC;4BACtB,IAAA,UAAI,EAAC,UAAG,SAAS,8BAA2B,EAAE,6BAAsB,QAAQ,CAAE,CAAC,CAAC;4BAChF,sBAAO;wBACX,CAAC;wBACD,QAAQ,GAAG,kBAAkB,CAAC,QAAQ,CAAC;;;wBAErC,aAAW,IAAA,+BAAY,EAAC,QAAQ,CAAC,CAAC;wBAExC,IAAI,IAAI,CAAC,wBAAwB,CAAC,GAAG,CAAC,UAAQ,CAAC,EAAE,CAAC;4BAC9C,IAAA,UAAI,EAAC,UAAG,SAAS,8BAA2B,EAAE,gCAAyB,UAAQ,CAAE,CAAC,CAAC;4BACnF,sBAAO;wBACX,CAAC;wBAEK,0BAA0B,GAAG;;;;;;wCAC/B,IAAA,SAAG,EAAC,UAAG,SAAS,yDAAsD,EAAE,UAAG,UAAQ,CAAE,CAAC,CAAC;wCACjF,WAAW,GAAG,IAAA,gBAAM,GAAE,CAAC,MAAM,CAAC,mBAAmB,CAAC,CAAC;wCACnD,WAAW,GAAG,QAAQ,CAAC;wCACvB,kBAAkB,GAAG,QAAQ,CAAC;wCACX,qBAAM,IAAA,gBAAM,EAAC,IAAI,CAAC,iBAAiB,CAAC,QAAQ,EAAE,WAAW,EAAE,WAAW,EAAE,kBAAoC,EAAE,eAAU,CAAC,MAAM,CAAC,CAAC,EAAA;;wCAAnJ,cAAc,GAAI,CAAA,SAAiI,CAAA,GAArI;wCAErB,IAAI,CAAC,IAAA,iBAAO,EAAC,cAAc,CAAC,EAAE,CAAC;4CACrB,KAAK,GAAG,cAAc,IAAI,cAAc,CAAC,CAAC,CAAC,CAAC;4CAC5C,IAAI,GAAG,CAAC,cAAc,IAAI,EAAE,CAAC,CAAC,cAAc,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;4CAE/D,IAAA,kBAAU,EAAC,cAAc,CAAC,CAAC;4CAE3B,IAAA,SAAG,EAAC,UAAG,SAAS,gEAA6D,EAAE,UAAG,cAAc,aAAd,cAAc,uBAAd,cAAc,CAAE,MAAM,8BAAoB,UAAQ,mBAAS,IAAA,0BAAa,EAAC,KAAK,aAAL,KAAK,uBAAL,KAAK,CAAE,IAAI,CAAC,iBAAO,IAAA,0BAAa,EAAC,IAAI,aAAJ,IAAI,uBAAJ,IAAI,CAAE,IAAI,CAAC,eAAK,IAAA,sBAAS,EAAC,KAAK,aAAL,KAAK,uBAAL,KAAK,CAAE,KAAK,CAAC,kBAAQ,IAAA,sBAAS,EAAC,IAAI,aAAJ,IAAI,uBAAJ,IAAI,CAAE,KAAK,CAAC,uBAAoB,CAAC,CAAC;4CAEvR,cAAc,CAAC,OAAO,CAAC,UAAC,cAAc;gDAClC,KAAI,CAAC,QAAQ,CAAC,cAAc,CAAC,CAAC;4CAClC,CAAC,CAAC,CAAC;4CACG,cAAc,GAAG,cAAc,CAAC,cAAc,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;4CACjE,IAAI,cAAc,EAAE,CAAC;gDACjB,mBAAiB,CAAC,iBAAiB,CAAC,QAAQ,CAAC,KAAK,EAAE,cAAc,CAAC,KAAK,CAAC,CAAC;4CAC9E,CAAC;wCACL,CAAC;;;;6BACJ,CAAA;wBAED,qBAAM,0BAA0B,EAAE,EAAA;;wBAAlC,SAAkC,CAAC;wBAEnC,IAAA,SAAG,EAAC,UAAG,SAAS,8BAA2B,EAAE,yBAAkB,UAAQ,CAAE,CAAC,CAAC;wBAC3E,IAAI,CAAC,wBAAwB,CAAC,GAAG,CAAC,UAAQ,EAAE,IAAI,CAAC,EAAE,CAAC,+BAA+B,CAAC,QAAQ,EAAE,CAAC,EAAE,KAAK,CAAC;6BAClG,IAAI,CACD,IAAA,iBAAU,EAAC,UAAC,KAAK;4BACb,IAAA,UAAI,EAAC,UAAG,SAAS,8BAA2B,EAAE,+BAAwB,UAAQ,CAAE,EAAE,KAAK,CAAC,CAAC;4BACzF,KAAI,CAAC,wBAAwB,CAAC,MAAM,CAAC,UAAQ,CAAC,CAAC;4BAC/C,OAAO,IAAA,SAAE,EAAC,IAAI,CAAC,CAAC;wBACpB,CAAC,CAAC,CACL;6BACA,SAAS,CAAC,UAAC,IAAI;4BACZ,IAAM,QAAQ,GAAsB;gCAChC,QAAQ,UAAA;gCACR,IAAI,EAAE,IAAI,IAAI,CAAC,CAAC,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC;gCACjC,KAAK,EAAE,IAAI,CAAC,KAAK;gCACjB,IAAI,EAAE,IAAI,CAAC,IAAI;gCACf,QAAQ,EAAE,IAAI,CAAC,QAAQ;gCACvB,iBAAiB,EAAE,IAAI,CAAC,iBAAiB;6BAC5C,CAAA;4BACD,KAAI,CAAC,uBAAuB,CAAC,QAAQ,CAAC,CAAC;4BACvC,6RAA6R;wBACjS,CAAC,CAAC,CAAC,CAAC;wBAER,IAAA,SAAG,EAAC,UAAG,SAAS,8BAA2B,EAAE,wBAAiB,UAAQ,CAAE,CAAC,CAAC;;;;wBAI1E,IAAA,UAAI,EAAC,gCAAgC,EAAE,GAAC,CAAC,CAAC;wBAC1C,sBAAO;;;;aAEd,CAAA;QAEO,6BAAuB,GAAG,UAAC,IAAuB;YACtD,IAAM,SAAS,GAAG,IAAA,+BAAY,EAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;YAC9C,IAAM,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC;YAC3B,IAAM,UAAU,GAAG,IAAI,IAAI,CAAC,QAAQ,CAAC,eAAe,CAAC,CAAC,CAAC,CAAC,CAAC;YACzD,IAAM,cAAc,GAAG,KAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;YAE9D,2CAA2C;YAC3C,IAAI,cAAc,EAAE,CAAC;gBACjB,IAAI,cAAc,CAAC,SAAS,KAAK,UAAU,CAAC,OAAO,EAAE,EAAE,CAAC;oBACpD,uCAAuC;oBACvC,cAAc,CAAC,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC;oBAClC,cAAc,CAAC,MAAM,IAAI,CAAC,IAAI,CAAC,IAAI,IAAI,CAAC,CAAC,CAAC;oBAC1C,cAAc,CAAC,KAAK,EAAE,CAAC;oBACvB,cAAc,CAAC,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,cAAc,CAAC,IAAI,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC;oBAChE,cAAc,CAAC,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,cAAc,CAAC,GAAG,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC;oBAE9D,KAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,SAAS,EAAE,cAAc,CAAC,CAAC;gBAE3D,CAAC;qBAAM,CAAC;oBACJ,8CAA8C;oBAC9C,KAAI,CAAC,QAAQ,CAAC,cAA4B,CAAC,CAAC,CAAC,iDAAiD;oBAC9F,SAAS,CAAC,IAAI,CAAC,mBAAU,CAAC,QAAQ,EAAE,cAAc,CAAC,CAAC;oBACpD,IAAA,cAAM,EAAC,UAAG,SAAS,SAAM,EAAE,cAA4B,CAAC,CAAC;oBAEzD,+BAA+B;oBAC/B,IAAM,MAAM,GAAmB;wBAC3B,UAAU,EAAE,IAAI,CAAC,QAAsB;wBACvC,IAAI,EAAE,QAAQ;wBACd,OAAO,EAAE,QAAQ,CAAC,OAAO,EAAE;wBAC3B,SAAS,EAAE,UAAU,CAAC,OAAO,EAAE;wBAC/B,KAAK,EAAE,CAAC;wBACR,IAAI,EAAE,IAAI,CAAC,KAAK;wBAChB,IAAI,EAAE,IAAI,CAAC,KAAK;wBAChB,GAAG,EAAE,IAAI,CAAC,KAAK;wBACf,KAAK,EAAE,IAAI,CAAC,KAAK;wBACjB,MAAM,EAAE,IAAI,CAAC,IAAI;qBACpB,CAAC;oBAEF,KAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,SAAS,EAAE,MAAM,CAAC,CAAC;gBACnD,CAAC;YACL,CAAC;iBAAM,CAAC;gBACJ,iCAAiC;gBACjC,IAAM,MAAM,GAAmB;oBAC3B,UAAU,EAAE,IAAI,CAAC,QAAsB;oBACvC,IAAI,EAAE,QAAQ;oBACd,OAAO,EAAE,QAAQ,CAAC,OAAO,EAAE;oBAC3B,SAAS,EAAE,UAAU,CAAC,OAAO,EAAE;oBAC/B,KAAK,EAAE,CAAC;oBACR,IAAI,EAAE,IAAI,CAAC,KAAK;oBAChB,IAAI,EAAE,IAAI,CAAC,KAAK;oBAChB,GAAG,EAAE,IAAI,CAAC,KAAK;oBACf,KAAK,EAAE,IAAI,CAAC,KAAK;oBACjB,MAAM,EAAE,IAAI,CAAC,IAAI;iBACpB,CAAC;gBAEF,KAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,SAAS,EAAE,MAAM,CAAC,CAAC;YACnD,CAAC;YAED,IAAI,IAAI,aAAJ,IAAI,uBAAJ,IAAI,CAAE,KAAK,EAAE,CAAC;gBACd,oBAAU,CAAC,QAAQ,CAAC,iBAAiB,CAAC,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC;YAC3E,CAAC;QACL,CAAC,CAAA;QAED,iCAA2B,GAAG,UAAC,QAAkB;YAC7C,IAAM,QAAQ,GAAG,KAAI,CAAC,YAAY,CAAC,QAAQ,CAAC,CAAC;YAC7C,IAAM,YAAY,GAAG,KAAI,CAAC,wBAAwB,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;YACjE,IAAI,YAAY,EAAE,CAAC;gBACf,YAAY,CAAC,WAAW,EAAE,CAAC;gBAC3B,KAAI,CAAC,wBAAwB,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;YACnD,CAAC;YACD,KAAI,CAAC,kBAAkB,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;QAC7C,CAAC,CAAC;QAEF,iBAAW,GAAG,UAAO,QAAiC;;;;;wBAClD,IAAK,QAA+B,aAA/B,QAAQ,uBAAR,QAAQ,CAAyB,QAAQ,EAAE,CAAC;4BAC7C,sBAAO,QAA8B,EAAC;wBAC1C,CAAC;wBAAA,CAAC;wBAEuB,qBAAM,IAAA,gBAAM,EAAC,IAAI,CAAC,EAAE,CAAC,kBAAkB,CAAC,QAAQ,CAAC,CAAC,EAAA;;wBAArE,KAAmB,SAAkD,EAApE,SAAS,QAAA,EAAE,GAAG,QAAA;wBACrB,IAAI,SAAS,IAAI,SAAS,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;4BAC9B,aAAa,GAAG,SAAS,CAAC,CAAC,CAAC,CAAC;4BACnC,4CACO,aAAa,GACb,aAAa,CAAC,QAAQ,GAC3B;wBACN,CAAC;wBACD,IAAI,GAAG,EAAE,CAAC;4BACN,IAAA,UAAI,EAAC,0BAAmB,IAAI,CAAC,SAAS,CAAC,QAAQ,IAAI,EAAE,CAAC,CAAE,EAAE,GAAG,CAAC,CAAC;wBACnE,CAAC;wBACD,sBAAO,IAAI,EAAC;;;aACf,CAAA;QAED,qBAAe,GAAG,UAAO,QAA2B;;;;4BAEvB,qBAAM,IAAA,gBAAM,EAAC,IAAI,CAAC,EAAE,CAAC,kBAAkB,CAAC,QAAQ,CAAC,CAAC,EAAA;;wBAArE,KAAmB,SAAkD,EAApE,SAAS,QAAA,EAAE,GAAG,QAAA;wBAErB,IAAI,SAAS,IAAI,SAAS,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;4BACpC,sBAAO,SAAS,CAAC,GAAG,CAAC,UAAA,CAAC;oCAClB,6BACO,CAAC,GACD,CAAC,CAAC,QAAQ,EACf;gCACN,CAAC,CAAC,EAAC;wBACP,CAAC;wBAED,IAAI,GAAG,EAAE,CAAC;4BACN,IAAA,UAAI,EAAC,0BAAmB,IAAI,CAAC,SAAS,CAAC,QAAQ,IAAI,EAAE,CAAC,CAAE,EAAE,GAAG,CAAC,CAAC;wBACnE,CAAC;wBACD,sBAAO,EAAE,EAAC;;;aACb,CAAA;QAED,UAAI,GAAG;YACH,IAAM,EAAE,GAAG,wBAAc,CAAC,QAAQ,CAAC,EAAE,CAAC;YAEtC,IAAI,CAAC,KAAI,CAAC,EAAE,EAAE,CAAC;gBACX,KAAI,CAAC,EAAE,GAAG,EAAE,CAAC;gBAEb,gCAAgC;gBAChC,6CAA6C;YACjD,CAAC;QACL,CAAC,CAAA;;IAID,CAAC;IAlaD,sBAAkB,6BAAQ;aAA1B;YACI,OAAO,IAAI,CAAC,SAAS,IAAI,CAAC,IAAI,CAAC,SAAS,GAAG,IAAI,IAAI,EAAE,CAAC,CAAC;QAC3D,CAAC;;;OAAA;IAkaL,wBAAC;AAAD,CAAC,AAjbD,CAAuC,gBAAU,GAibhD;AAjbY,8CAAiB;AAmb9B,kBAAe,iBAAiB,CAAC","sourcesContent":["import moment from 'moment';\nimport { catchError, lastValueFrom, of, Subscription } from \"rxjs\";\nimport IBKRConnection from '../connection/IBKRConnection';\nimport { IBApiNext, Contract, BarSizeSetting, WhatToShow, ContractDetails, HistoricalTickLast } from '@stoqey/ib';\nimport { MarketData, TickByTickAllLast } from '../interfaces';\nimport awaitP from '../utils/awaitP';\nimport { Instrument } from '../interfaces';\nimport { log, warn } from '../utils/log';\nimport { IBKREvents, IBKREVENTS } from \"../events\";\nimport Portfolios from '../portfolios/Portfolios';\nimport isEmpty from 'lodash/isEmpty';\nimport { formatDateStr } from '../utils/time.utils';\nimport { getSymbolKey } from '../utils/instrument.utils';\nimport { formatDec } from '../utils/data.utils';\nimport { plotMkdCli } from '../utils/chart';\nimport sortBy from 'lodash/sortBy';\nimport { logBar } from '../utils';\nimport { createAggregator } from '../utils/mkd.utils';\nimport { MkdManager } from './Mkd';\n\nconst appEvents = IBKREvents.Instance;\n\nexport interface ContractInstrument extends Contract, ContractDetails {\n    contract: Contract;\n}\n\nconst logsNames = 'MkdMgr';\n\ninterface CurrentBarData extends Partial<MarketData> {\n    barTime: number;\n    barMinute?: number;\n    barSecond?: number;\n    cumulativeVolume?: number;\n}\n\ninterface MarketDataItem extends MarketData {\n    timestamp?: number;\n}\n\nexport class MarketDataManager extends MkdManager {\n    logsNames = logsNames;\n    ib: IBApiNext;\n\n    private GetHistoricalDataUpdates: Map<string, Subscription> = new Map();\n    private GetTickByTickDataUpdates: Map<string, Subscription> = new Map();\n\n    private currentBarData: Map<string, CurrentBarData> = new Map();\n    private currentTickBarData: Map<string, CurrentBarData> = new Map();\n\n\n    private static _instance: MarketDataManager;\n\n    public static get Instance(): MarketDataManager {\n        return this._instance || (this._instance = new this());\n    }\n\n    removeHistoricalDataUpdates = (contract: Contract): void => {\n        const symbolId = this.getSymbolKey(contract);\n        const subscription = this.GetHistoricalDataUpdates.get(symbolId);\n        if (subscription) {\n            subscription.unsubscribe();\n            this.GetHistoricalDataUpdates.delete(symbolId);\n        }\n        this.currentBarData.delete(symbolId);\n    };\n\n\n    getHistoricalDataUpdates = async (contract: Contract, barSizeSetting: BarSizeSetting, whatToShow: WhatToShow): Promise<void> => {\n        try {\n\n            const portfoliosManager = Portfolios.Instance;\n\n            if (!contract.conId || !contract.exchange) {\n                contract = await this.getContract(contract as Contract);\n            }\n            const symbolId = this.getSymbolKey(contract);\n\n            if (this.GetHistoricalDataUpdates.has(symbolId)) {\n                warn(`${logsNames}.getHistoricalDataUpdates`, `Already subscribed to ${symbolId}`);\n                return;\n            }\n\n            const getMarketDataLast30Minutes = async () => {\n                log(`${logsNames}.getHistoricalDataUpdates.getMarketDataLast30Minutes`, `${symbolId}`);\n                const endDateTime = moment().format('YYYYMMDD HH:mm:ss');\n                const durationStr = '3600 S';\n                const barSizeSetting5Sec = '5 secs';\n                const [historicalData] = await awaitP(this.getHistoricalData(contract, endDateTime, durationStr, barSizeSetting5Sec as BarSizeSetting, whatToShow));\n\n                if (!isEmpty(historicalData)) {\n                    const first = historicalData && historicalData[0];\n                    const last = (historicalData || [])[historicalData.length - 1];\n\n                    plotMkdCli(historicalData);\n\n                    log(`${logsNames}.getHistoricalDataUpdates.getMarketDataLast30Minutes.length`, `${historicalData?.length} data points for ${symbolId} from ${formatDateStr(first?.date)} to ${formatDateStr(last?.date)} @${formatDec(first?.close)} -> @${formatDec(last?.close)} whatToShow=${whatToShow}`);\n                    historicalData.forEach((marketDataItem) => {\n                        this.cacheBar(marketDataItem);\n                    });\n                    const lastMarketData = historicalData[historicalData.length - 1];\n                    if (lastMarketData) {\n                        portfoliosManager.updateMarketPrice(contract.conId, lastMarketData.close);\n                    }\n                }\n            }\n\n            await getMarketDataLast30Minutes();\n\n            log(`${logsNames}.getHistoricalDataUpdates`, `Subscribing to ${symbolId}`);\n            this.GetHistoricalDataUpdates.set(symbolId, IBKRConnection.Instance.ib.getHistoricalDataUpdates(contract, barSizeSetting, whatToShow, 2)\n                .pipe(\n                    catchError((error) => {\n                        warn(`${logsNames}.getHistoricalDataUpdates`, `Error subscribing to ${symbolId}`, error);\n                        this.GetHistoricalDataUpdates.delete(symbolId);\n                        return of(null);\n                    })\n                )\n                .subscribe((bar) => {\n                    if (!bar) return;\n                    const currentTime = new Date(); // Use current time for consistent bar-to-bar timing\n                    const barTime = +bar.time * 1000; // IBKR's bar timestamp\n                    const barMinute = new Date(currentTime).setSeconds(0, 0); // use current time since bigger intervals send same timestamp for each bar\n                    const prevBarData = this.currentBarData.get(symbolId);\n\n                    let incrementalVolume = bar.volume;\n\n                    if (prevBarData && prevBarData?.barMinute === barMinute) {\n                        incrementalVolume = Math.max(0, bar.volume - prevBarData.cumulativeVolume);\n                    }\n\n                    this.currentBarData.set(symbolId, {\n                        barTime: barTime,\n                        cumulativeVolume: bar.volume,\n                        barMinute\n                    });\n\n                    const marketDataItem: MarketData = {\n                        instrument: contract as Instrument,\n                        date: currentTime, // Use current time instead of bar.time\n                        open: bar.open,\n                        high: bar.high,\n                        low: bar.low,\n                        close: bar.close,\n                        volume: incrementalVolume, // Use incremental volume\n                        wap: bar.WAP,\n                        vwap: bar.WAP,\n                        count: bar?.count,\n                    };\n\n                    this.cacheBar(marketDataItem);\n\n\n                    if (bar?.close) {\n                        portfoliosManager.updateMarketPrice(contract.conId, bar.close);\n                    }\n\n                    appEvents.emit(IBKREVENTS.IBKR_BAR, marketDataItem);\n\n                    const volumeStr = incrementalVolume > 0 ? `vol=${incrementalVolume}` : '';\n                    const cumulativeStr = bar.volume !== incrementalVolume ? `cumVol=${bar.volume}` : '';\n                    const isNewBar = !prevBarData || prevBarData.barMinute !== barMinute;\n                    const barStatus = isNewBar ? '[NEW]' : '[UPD]';\n                    log(`${logsNames}.HDU`, `bar for ${symbolId} at ${formatDateStr(currentTime)} @${bar.close} ${volumeStr} ${cumulativeStr} ${barStatus}`.trim());\n                }));\n\n        } catch (e) {\n            warn(\"getHistoricalDataUpdates error\", e);\n            return;\n        }\n    }\n\n\n    getHistoricalData = async (contract: Contract, endDateTime: string | undefined, durationStr: string, barSizeSetting: BarSizeSetting, whatToShow: WhatToShow, useRTH = false): Promise<MarketData[]> => {\n        const [contractInstrument, errContract] = await awaitP(this.getContract(contract));\n        if (errContract) {\n            warn(\"getHistoricalData contract err\", errContract);\n            return null;\n        }\n        if (!contractInstrument) {\n            warn(\"getHistoricalData contract not found\", contract);\n            return null;\n        }\n\n        const symbol = this.getSymbolKey(contractInstrument);\n        const [bars, err] = await awaitP(IBKRConnection.Instance.ib.getHistoricalData(contractInstrument, endDateTime, durationStr, barSizeSetting, whatToShow, useRTH, 2));\n        if (bars && bars.length > 0) {\n            const mkd = bars.map(bar => {\n                const date = new Date(+bar.time * 1000);\n                const marketDataItem: MarketData = {\n                    instrument: contractInstrument?.contract as Instrument,\n                    date,\n                    open: bar.open,\n                    high: bar.high,\n                    low: bar.low,\n                    close: bar.close,\n                    volume: bar.volume,\n                    wap: bar.WAP,\n                    vwap: bar.WAP, // same as wap\n                    count: bar?.count,\n                };\n                return marketDataItem;\n            });\n\n            return sortBy(mkd, 'date');\n        }\n        if (err) {\n            warn(`getHistoricalData err ${symbol}`, err);\n        }\n        return null;\n    };\n\n    getHistoricalTicksLast = async (contract: Contract, startDate: Date | string, endDate?: Date | string, numberOfTicks = 1000, useRTH = false): Promise<TickByTickAllLast[]> => {\n        if (!startDate) {\n            warn(\"getHistoricalTicksLast startDate not set\");\n            return null;\n        }\n\n        if (endDate && startDate > endDate) {\n            warn(\"getHistoricalTicksLast startDate cannot be great than endDate\");\n            return null;\n        }\n\n        const startDateTime = typeof startDate === 'string' ? startDate : moment(startDate).format('YYYYMMDD HH:mm:ss');\n        const endDateTime = typeof endDate === 'string' ? endDate : moment(endDate).format('YYYYMMDD HH:mm:ss');\n\n        const [contractInstrument, errContract] = await awaitP(this.getContract(contract));\n        if (errContract) {\n            warn(\"getHistoricalTicksLast contract err\", errContract);\n            return null;\n        }\n        if (!contractInstrument) {\n            warn(\"getHistoricalTicksLast contract not found\", contract);\n            return null;\n        }\n\n        const symbol = this.getSymbolKey(contractInstrument);\n\n        const [ticks, err] = await awaitP(lastValueFrom(\n            IBKRConnection.Instance.ib.getHistoricalTicksLast(\n                contractInstrument,\n                startDateTime,\n                endDateTime,\n                numberOfTicks,\n                useRTH\n            )\n        ));\n\n        if (ticks && ticks.length > 0) {\n            const mkd = ticks.map(bar => {\n                const date = new Date(+bar.time * 1000);\n                const tickDataItem: TickByTickAllLast = {\n                    contract: contractInstrument?.contract as Contract,\n                    date,\n                    price: bar.price,\n                    size: bar.size,\n                    exchange: bar.exchange,\n                    specialConditions: bar.specialConditions,\n                };\n                return tickDataItem;\n            });\n\n            return sortBy(mkd, 'date');\n        }\n        if (err) {\n            warn(`getHistoricalTicksLast err ${symbol}`, err);\n        }\n        return null;\n    };\n\n    getTickByTickDataUpdates = async (contract: Contract): Promise<void> => {\n        try {\n            const portfoliosManager = Portfolios.Instance;\n\n            if (!contract.conId || !contract.exchange) {\n                const contractInstrument = (await this.getContract(contract as Contract));\n                if (!contractInstrument) {\n                    warn(`${logsNames}.getTickByTickDataUpdates`, `Contract not found ${contract}`);\n                    return;\n                }\n                contract = contractInstrument.contract;\n            }\n            const symbolId = getSymbolKey(contract);\n\n            if (this.GetTickByTickDataUpdates.has(symbolId)) {\n                warn(`${logsNames}.getTickByTickDataUpdates`, `Already subscribed to ${symbolId}`);\n                return;\n            }\n\n            const getMarketDataLast30Minutes = async () => {\n                log(`${logsNames}.getTickByTickDataUpdates.getMarketDataLast30Minutes`, `${symbolId}`);\n                const endDateTime = moment().format('YYYYMMDD HH:mm:ss');\n                const durationStr = '3600 S';\n                const barSizeSetting5Sec = '5 secs';\n                const [historicalData] = await awaitP(this.getHistoricalData(contract, endDateTime, durationStr, barSizeSetting5Sec as BarSizeSetting, WhatToShow.TRADES));\n\n                if (!isEmpty(historicalData)) {\n                    const first = historicalData && historicalData[0];\n                    const last = (historicalData || [])[historicalData.length - 1];\n\n                    plotMkdCli(historicalData);\n\n                    log(`${logsNames}.getTickByTickDataUpdates.getMarketDataLast30Minutes.length`, `${historicalData?.length} data points for ${symbolId} from ${formatDateStr(first?.date)} to ${formatDateStr(last?.date)} @${formatDec(first?.close)} -> @${formatDec(last?.close)} whatToShow=TRADES`);\n\n                    historicalData.forEach((marketDataItem) => {\n                        this.cacheBar(marketDataItem);\n                    });\n                    const lastMarketData = historicalData[historicalData.length - 1];\n                    if (lastMarketData) {\n                        portfoliosManager.updateMarketPrice(contract.conId, lastMarketData.close);\n                    }\n                }\n            }\n\n            await getMarketDataLast30Minutes();\n\n            log(`${logsNames}.getTickByTickDataUpdates`, `Subscribing to ${symbolId}`);\n            this.GetTickByTickDataUpdates.set(symbolId, this.ib.getTickByTickAllLastDataUpdates(contract, 0, false)\n                .pipe(\n                    catchError((error) => {\n                        warn(`${logsNames}.getTickByTickDataUpdates`, `Error subscribing to ${symbolId}`, error);\n                        this.GetTickByTickDataUpdates.delete(symbolId);\n                        return of(null);\n                    })\n                )\n                .subscribe((tick) => {\n                    const tickData: TickByTickAllLast = {\n                        contract,\n                        date: new Date(+tick.time * 1000),\n                        price: tick.price,\n                        size: tick.size,\n                        exchange: tick.exchange,\n                        specialConditions: tick.specialConditions,\n                    }\n                    this.onTickByTickDataUpdates(tickData);\n                    // log(`${logsNames}.TDU`, `tick for ${symbolId} at ${formatDateStr(new Date(tickData.date))} @${tickData.price} size=${tickData.size}  ${tickData.exchange ? `exchange=${tickData.exchange}` : ''} ${tickData.specialConditions ? `specialConditions=${tickData.specialConditions}` : ''}`);\n                }));\n\n            log(`${logsNames}.getTickByTickDataUpdates`, `Subscribed to ${symbolId}`);\n\n\n        } catch (e) {\n            warn(\"getTickByTickDataUpdates error\", e);\n            return;\n        }\n    }\n\n    private onTickByTickDataUpdates = (tick: TickByTickAllLast) => {\n        const symbolKey = getSymbolKey(tick.contract);\n        const tickDate = tick.date;\n        const tickSecond = new Date(tickDate.setMilliseconds(0));\n        const currentBarData = this.currentTickBarData.get(symbolKey);\n\n        // If we have existing data for this symbol\n        if (currentBarData) {\n            if (currentBarData.barSecond === tickSecond.getTime()) {\n                // SAME SECOND: Update the existing bar\n                currentBarData.close = tick.price;\n                currentBarData.volume += (tick.size || 0);\n                currentBarData.count++;\n                currentBarData.high = Math.max(currentBarData.high, tick.price);\n                currentBarData.low = Math.min(currentBarData.low, tick.price);\n\n                this.currentTickBarData.set(symbolKey, currentBarData);\n\n            } else {\n                // NEW SECOND: Send completed bar, start fresh\n                this.cacheBar(currentBarData as MarketData); // saves it just like the historical data updates\n                appEvents.emit(IBKREVENTS.IBKR_BAR, currentBarData);\n                logBar(`${logsNames}.TDU`, currentBarData as MarketData);\n\n                // Create new bar for this tick\n                const newBar: CurrentBarData = {\n                    instrument: tick.contract as Instrument,\n                    date: tickDate,\n                    barTime: tickDate.getTime(),\n                    barSecond: tickSecond.getTime(),\n                    count: 1,\n                    open: tick.price,\n                    high: tick.price,\n                    low: tick.price,\n                    close: tick.price,\n                    volume: tick.size\n                };\n\n                this.currentTickBarData.set(symbolKey, newBar);\n            }\n        } else {\n            // FIRST TICK: Create initial bar\n            const newBar: CurrentBarData = {\n                instrument: tick.contract as Instrument,\n                date: tickDate,\n                barTime: tickDate.getTime(),\n                barSecond: tickSecond.getTime(),\n                count: 1,\n                open: tick.price,\n                high: tick.price,\n                low: tick.price,\n                close: tick.price,\n                volume: tick.size\n            };\n\n            this.currentTickBarData.set(symbolKey, newBar);\n        }\n\n        if (tick?.price) {\n            Portfolios.Instance.updateMarketPrice(tick.contract.conId, tick.price);\n        }\n    }\n\n    removeTickByTickDataUpdates = (contract: Contract): void => {\n        const symbolId = this.getSymbolKey(contract);\n        const subscription = this.GetTickByTickDataUpdates.get(symbolId);\n        if (subscription) {\n            subscription.unsubscribe();\n            this.GetTickByTickDataUpdates.delete(symbolId);\n        }\n        this.currentTickBarData.delete(symbolId);\n    };\n\n    getContract = async (contract: Partial<Contract | any>): Promise<ContractInstrument> => {\n        if ((contract as ContractInstrument)?.contract) {\n            return contract as ContractInstrument;\n        };\n\n        const [contracts, err] = await awaitP(this.ib.getContractDetails(contract));\n        if (contracts && contracts.length > 0) {\n            const firstContract = contracts[0];\n            return {\n                ...firstContract,\n                ...firstContract.contract\n            };\n        }\n        if (err) {\n            warn(`getContract err ${JSON.stringify(contract || {})}`, err);\n        }\n        return null;\n    }\n\n    searchContracts = async (contract: Partial<Contract>): Promise<ContractInstrument[]> => {\n\n        const [contracts, err] = await awaitP(this.ib.getContractDetails(contract));\n\n        if (contracts && contracts.length > 0) {\n            return contracts.map(c => {\n                return {\n                    ...c,\n                    ...c.contract\n                };\n            });\n        }\n\n        if (err) {\n            warn(`getContract err ${JSON.stringify(contract || {})}`, err);\n        }\n        return [];\n    }\n\n    init = () => {\n        const ib = IBKRConnection.Instance.ib;\n\n        if (!this.ib) {\n            this.ib = ib;\n\n            // ib.getHistoricalData // async\n            // ib.getHistoricalDataUpdates() // subscribe\n        }\n    }\n\n    private constructor() {\n        super();\n    }\n\n}\n\nexport default MarketDataManager;"]}