{"version":3,"file":"mkd.utils.js","sourceRoot":"","sources":["../../src/utils/mkd.utils.ts"],"names":[],"mappings":"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","sourcesContent":["import _ from 'lodash';\nimport { MarketData } from '../interfaces';\n\nexport interface AggregatedData extends MarketData {\n  [key: string]: any;\n}\n\ntype IntervalUnit = 's' | 'm' | 'h' | 'd' | 'w' | 'M' | 'y';\n\ninterface IntervalConfig {\n  value: number;\n  unit: IntervalUnit;\n}\n\n/**\n * Parse interval string like '1s', '5m', '1h', etc.\n */\nexport function parseInterval(interval: string = '1m'): IntervalConfig {\n  const match = interval.match(/^(\\d+)([smhdwMy])$/);\n  if (!match) {\n    throw new Error(`Invalid interval format: ${interval}. Use format like '1s', '5m', '1h', etc.`);\n  }\n  \n  return {\n    value: parseInt(match[1]),\n    unit: match[2] as IntervalUnit\n  };\n}\n\n/**\n * Get the start of an interval for a given date\n */\nexport function getIntervalStart(date: Date, config: IntervalConfig): Date {\n  const d = new Date(date);\n  \n  switch (config.unit) {\n    case 's':\n      d.setSeconds(Math.floor(d.getSeconds() / config.value) * config.value);\n      d.setMilliseconds(0);\n      break;\n    case 'm':\n      d.setMinutes(Math.floor(d.getMinutes() / config.value) * config.value);\n      d.setSeconds(0);\n      d.setMilliseconds(0);\n      break;\n    case 'h':\n      d.setHours(Math.floor(d.getHours() / config.value) * config.value);\n      d.setMinutes(0);\n      d.setSeconds(0);\n      d.setMilliseconds(0);\n      break;\n    case 'd':\n      d.setHours(0, 0, 0, 0);\n      if (config.value > 1) {\n        const daysSinceEpoch = Math.floor(d.getTime() / (86400000));\n        const intervalStart = Math.floor(daysSinceEpoch / config.value) * config.value;\n        d.setTime(intervalStart * 86400000);\n      }\n      break;\n    case 'w':\n      const dayOfWeek = d.getDay();\n      const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Monday = 0\n      d.setDate(d.getDate() - diff);\n      d.setHours(0, 0, 0, 0);\n      if (config.value > 1) {\n        const weeksSinceEpoch = Math.floor(d.getTime() / (604800000));\n        const intervalStart = Math.floor(weeksSinceEpoch / config.value) * config.value;\n        d.setTime(intervalStart * 604800000);\n      }\n      break;\n    case 'M':\n      d.setDate(1);\n      d.setHours(0, 0, 0, 0);\n      if (config.value > 1) {\n        const monthsSinceEpoch = d.getFullYear() * 12 + d.getMonth();\n        const intervalStart = Math.floor(monthsSinceEpoch / config.value) * config.value;\n        d.setFullYear(Math.floor(intervalStart / 12));\n        d.setMonth(intervalStart % 12);\n      }\n      break;\n    case 'y':\n      d.setMonth(0, 1);\n      d.setHours(0, 0, 0, 0);\n      if (config.value > 1) {\n        d.setFullYear(Math.floor(d.getFullYear() / config.value) * config.value);\n      }\n      break;\n  }\n  \n  return d;\n}\n\n/**\n * Default aggregators using lodash\n */\nexport const defaultAggregators = {\n  sum: (values: number[]) => _.sum(values),\n  mean: (values: number[]) => _.mean(values),\n  avg: (values: number[]) => _.mean(values),  // Alias for mean\n  average: (values: number[]) => _.mean(values),  // Another alias\n  median: (values: number[]) => {\n    const sorted = _.sortBy(values);\n    const mid = Math.floor(sorted.length / 2);\n    return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;\n  },\n  min: (values: number[]) => _.min(values),\n  max: (values: number[]) => _.max(values),\n  first: (values: any[]) => _.first(values),\n  last: (values: any[]) => _.last(values),\n  count: (values: any[]) => values.length,\n  stdDev: (values: number[]) => {\n    const mean = _.mean(values);\n    const variance = _.mean(values.map(v => Math.pow(v - mean, 2)));\n    return Math.sqrt(variance);\n  }\n};\n\n/**\n * Aggregate market data by time intervals\n * @param data Array of market data points\n * @param interval Interval string (e.g., '1s', '5m', '1h', '1d', '1w', '1M', '1y')\n * @param customAggregators Optional custom aggregation functions for additional fields\n */\nexport function aggregateByInterval(\n  data: MarketData[],\n  interval: string,\n  customAggregators?: Record<string, (values: any[]) => any>\n): AggregatedData[] {\n  if (_.isEmpty(data)) {\n    return [];\n  }\n  \n  const config = parseInterval(interval);\n  \n  // Group data by interval using lodash\n  const grouped = _.groupBy(data, (item) => {\n    return getIntervalStart(item.date, config).toISOString();\n  });\n  \n  // Aggregate each group\n  const results = _.map(grouped, (items, intervalKey) => {\n    // Sort items by date\n    const sortedItems = _.sortBy(items, item => item.date.getTime());\n    \n    // Determine if we're working with tick data (price) or OHLC data\n    const isTickData = sortedItems[0].price !== undefined;\n    \n    let ohlc: Partial<AggregatedData>;\n    \n    if (isTickData) {\n      // For tick data, we need to construct OHLC from prices\n      const prices = _.compact(sortedItems.map(item => item.price));\n      ohlc = {\n        open: _.first(prices) ?? 0,\n        high: _.max(prices) ?? 0,\n        low: _.min(prices) ?? 0,\n        close: _.last(prices) ?? 0,\n      };\n    } else {\n      // For pre-aggregated OHLC data, we need to aggregate properly\n      ohlc = {\n        open: _.first(sortedItems)?.open ?? 0,\n        high: _.max(_.compact(sortedItems.map(item => item.high))) ?? 0,\n        low: _.min(_.compact(sortedItems.map(item => item.low))) ?? 0,\n        close: _.last(sortedItems)?.close ?? 0,\n      };\n    }\n    \n    const aggregated: AggregatedData = {\n      interval: new Date(intervalKey),\n      date: new Date(intervalKey),\n      ...ohlc as { open: number; high: number; low: number; close: number },\n      volume: _.sumBy(sortedItems, 'volume') || 0,\n      count: sortedItems.length\n    };\n    \n    // Get all unique fields across all items\n    const allFields = _.uniq(_.flatMap(sortedItems, Object.keys));\n    \n    // Apply custom aggregators for additional fields\n    const fieldsToAggregate = _.without(allFields, 'date', 'open', 'high', 'low', 'close', 'volume', 'price');\n    \n    _.forEach(fieldsToAggregate, (field) => {\n      const values = _.compact(sortedItems.map(item => item[field]));\n      if (!_.isEmpty(values)) {\n        if (customAggregators?.[field]) {\n          aggregated[field] = customAggregators[field](values);\n        }\n      }\n    });\n    \n    return aggregated;\n  });\n  \n  // Sort results by interval\n  return _.sortBy(results, 'interval');\n}\n\n/**\n * Helper function to create common aggregation patterns\n */\nexport function createAggregator(\n  data: MarketData[],\n  interval: string,\n  fieldAggregators: Record<string, keyof typeof defaultAggregators | ((values: any[]) => any)>\n): AggregatedData[] {\n  const aggregators = _.mapValues(fieldAggregators, (aggregator) => {\n    return _.isString(aggregator) ? defaultAggregators[aggregator] : aggregator;\n  });\n  \n  return aggregateByInterval(data, interval, aggregators);\n}\n\n// Utility function for common statistical aggregations\nexport function aggregateWithStats(data: MarketData[], interval: string): AggregatedData[] {\n  return createAggregator(data, interval, {\n    priceStdDev: (values) => defaultAggregators.stdDev(values),\n    priceMean: 'mean',\n    priceMedian: 'median',\n    tradeCount: 'count',\n    maxVolume: 'max',\n    minVolume: 'min'\n  });\n}"]}