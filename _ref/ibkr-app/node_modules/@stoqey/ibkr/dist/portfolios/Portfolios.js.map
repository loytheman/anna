{"version":3,"file":"Portfolios.js","sourceRoot":"","sources":["../../src/portfolios/Portfolios.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,6BAAoE;AACpE,iCAA2F;AAC3F,4CAA+C;AAC/C,2DAAqC;AACrC,sFAAgE;AAChE,gDAAiD;AACjD,oCAAoC;AAMpC;IAeI;QAAA,iBAAyB;QAXjB,sBAAiB,GAA0B,IAAI,GAAG,EAAE,CAAC;QACrD,oBAAe,GAA0B,IAAI,GAAG,EAAE,CAAC;QACnD,gBAAW,GAAwB,IAAI,GAAG,EAAE,CAAC;QAC7C,eAAU,GAAsB,IAAI,GAAG,EAAE,CAAC;QAclD,sBAAiB,GAAG,UAAC,KAAa,EAAE,KAAa;;YAC7C,IAAM,QAAQ,GAAG,MAAA,KAAI,CAAC,iBAAiB,0CAAE,GAAG,CAAC,KAAK,CAAC,CAAC;YACpD,IAAI,QAAQ,EAAE,CAAC;gBACX,IAAM,WAAW,gBAAQ,QAAQ,CAAE,CAAC;gBACpC,WAAW,CAAC,WAAW,GAAG,KAAK,CAAC;gBAChC,KAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,KAAK,EAAE,WAAW,CAAC,CAAC;YACnD,CAAC;QACL,CAAC,CAAC;QAEF,kBAAa,GAAG,UAAC,KAAa;YAC1B,OAAO,KAAI,CAAC,WAAW,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;QACvC,CAAC,CAAA;QAED,iBAAY,GAAG,UAAC,KAAa;YACzB,OAAO,KAAI,CAAC,UAAU,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;QACtC,CAAC,CAAA;QAMD,iBAAY,GAAG,UAAC,UAAoB,EAAE,SAAiB;;YAAjB,0BAAA,EAAA,iBAAiB;YACnD,IAAI,CAAC,UAAU,EAAE,CAAC;gBACd,OAAO;YACX,CAAC;YAED,IAAI,QAAQ,gBAAa,UAAU,CAAE,CAAC;YAEtC,IAAM,UAAU,GAAG,MAAA,QAAQ,aAAR,QAAQ,uBAAR,QAAQ,CAAE,QAAQ,0CAAE,KAAK,CAAC;YAC7C,IAAI,UAAU,EAAE,CAAC;gBACb,IAAI,QAAQ,CAAC,QAAQ,CAAC,QAAQ,KAAK,OAAO,EAAE,CAAC;oBACzC,OAAO;gBACX,CAAC;gBAED,IAAI,CAAC,QAAQ,CAAC,GAAG,EAAE,CAAC;oBAChB,IAAM,eAAe,GAAG,KAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;oBAC/D,IAAI,eAAe,EAAE,CAAC;wBAClB,KAAI,CAAC,eAAe,CAAC,GAAG,CAAC,UAAU,EAAE,eAAe,CAAC,CAAC;wBACtD,KAAI,CAAC,iBAAiB,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC;wBAC1C,KAAI,CAAC,WAAW,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC;wBACpC,KAAI,CAAC,UAAU,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC;wBACnC,IAAA,uBAAW,EAAC,yBAAyB,EAAE,eAAe,EAAE,IAAI,CAAC,CAAC;oBAClE,CAAC;gBACL,CAAC;qBAAM,CAAC;oBACJ,kDAAkD;oBAClD,QAAQ,CAAC,SAAS,GAAG,IAAI,IAAI,EAAE,CAAC;oBAChC,IAAM,UAAU,GAAG,QAAQ,CAAC,QAAQ,CAAC,UAAU,CAAC;oBAChD,IAAI,UAAU,EAAE,CAAC;wBACb,QAAQ,CAAC,OAAO,GAAG,QAAQ,CAAC,OAAO,GAAG,UAAU,CAAC;oBACrD,CAAC;oBAED,KAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,UAAU,EAAE,QAAQ,CAAC,CAAC;oBACjD,KAAI,CAAC,WAAW,CAAC,GAAG,CAAC,UAAU,EAAE,QAAQ,CAAC,OAAO,CAAC,CAAC;oBACnD,KAAI,CAAC,UAAU,CAAC,GAAG,CAAC,UAAU,EAAE,QAAQ,CAAC,SAAS,CAAC,CAAC;oBAEpD,IAAI,KAAI,CAAC,eAAe,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE,CAAC;wBACvC,KAAI,CAAC,eAAe,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC;oBAC5C,CAAC;oBAED,kBAAkB;oBAClB,IAAI,SAAS,EAAE,CAAC;wBACZ,IAAM,KAAK,GAAG,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC;wBAC/B,IAAM,UAAU,GAAG,KAAK,CAAC,CAAC,CAAC,eAAU,CAAC,GAAG,CAAC,CAAC,CAAC,eAAU,CAAC,GAAG,CAAC;wBAC3D,IAAM,OAAO,GAAG,QAAQ,CAAC;wBACzB,2BAAiB,CAAC,QAAQ,CAAC,wBAAwB,CAAC,QAAQ,CAAC,QAAQ,EAAE,OAAyB,EAAE,UAAU,CAAC,CAAC;oBAClH,CAAC;oBACD,IAAA,uBAAW,EAAC,yBAAyB,EAAE,QAAQ,CAAC,CAAC;gBACrD,CAAC;YAEL,CAAC;YACD,OAAO,QAAQ,CAAA;QACnB,CAAC,CAAA;QAED;;WAEG;QACH,oBAAe,GAAG;;;;;4BACO,qBAAM,IAAA,qBAAc,EAAC,IAAI,CAAC,EAAE,CAAC,YAAY,EAAE,CAAC,EAAA;;wBAA3D,YAAY,GAAG,SAA4C;wBAC7D,SAAS,GAAe,EAAE,CAAC;wBAC/B,YAAY,CAAC,GAAG,CAAC,OAAO,CAAC,UAAC,KAAK,EAAE,GAAG;4BAChC,SAAS,GAAG,IAAA,iBAAO,EAAC,KAAK,CAAC,GAAG,CAAC,UAAC,QAAQ,IAAK,OAAA,KAAI,CAAC,YAAY,CAAC,QAAQ,CAAC,EAA3B,CAA2B,CAAC,CAAC,CAAC;wBAC9E,CAAC,CAAC,CAAC;wBAEH,sBAAO,SAAS,EAAC;;;aACpB,CAAA;QAED,mBAAc,GAAG;YACb,2BAAiB,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC;YAClC,KAAI,CAAC,YAAY,GAAG,KAAI,CAAC,EAAE,CAAC,YAAY,EAAE;iBAEzC,IAAI,CACD,IAAA,iBAAU,EAAC,UAAC,KAAK;gBACb,IAAA,UAAI,EAAC,gBAAgB,EAAE,gCAAgC,EAAE,KAAK,CAAC,CAAC;gBAChE,OAAO,IAAA,SAAE,EAAC,IAAI,CAAC,CAAC;YACpB,CAAC,CAAC,CACL;iBACA,SAAS,CAAC,UAAC,cAAc;gBACtB,cAAc,CAAC,GAAG,CAAC,OAAO,CAAC,UAAC,KAAK,EAAE,GAAG;oBAClC,KAAK,CAAC,OAAO,CAAC,UAAC,QAAQ,IAAK,OAAA,KAAI,CAAC,YAAY,CAAC,QAAQ,CAAC,EAA3B,CAA2B,CAAC,CAAC;gBAC7D,CAAC,CAAC,CAAC;YACP,CAAC,CAAC,CAAC;QACP,CAAC,CAAA;QAED,eAAU,GAAG;YACT,KAAI,CAAC,YAAY,CAAC,WAAW,EAAE,CAAC;QACpC,CAAC,CAAA;QAED,iBAAY,GAAG;;gBACX,sBAAO,IAAI,CAAC,eAAe,EAAE,EAAC;;aACjC,CAAA;QAED,SAAI,GAAG;YACH,IAAI,CAAC,KAAI,CAAC,EAAE,EAAE,CAAC;gBACX,KAAI,CAAC,EAAE,GAAG,2BAAc,CAAC,QAAQ,CAAC,EAAE,CAAC;gBACrC,KAAI,CAAC,cAAc,EAAE,CAAC;YAC1B,CAAC;QACL,CAAC,CAAC;IA1HsB,CAAC;IAJzB,sBAAkB,sBAAQ;aAA1B;YACI,OAAO,IAAI,CAAC,SAAS,IAAI,CAAC,IAAI,CAAC,SAAS,GAAG,IAAI,IAAI,EAAE,CAAC,CAAC;QAC3D,CAAC;;;OAAA;IAID,sBAAI,iCAAS;aAAb;YACI,OAAO,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,iBAAiB,CAAC,MAAM,EAAE,CAAC,CAAC;QACvD,CAAC;;;OAAA;IAmBD,4CAAuB,GAAvB,UAAwB,KAAa;QACjC,OAAO,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;IAC3C,CAAC;IAmGL,iBAAC;AAAD,CAAC,AA3ID,IA2IC;AA3IY,gCAAU;AA6IvB,kBAAe,UAAU,CAAC","sourcesContent":["import { Subscription, catchError, firstValueFrom, of } from 'rxjs';\nimport { Position as IBPOSITION, IBApiNext, WhatToShow, BarSizeSetting } from '@stoqey/ib';\nimport { IBKRConnection } from '../connection';\nimport compact from 'lodash/compact';\nimport MarketDataManager from '../marketdata/MarketDataManager';\nimport { logPosition } from '../utils/log.utils';\nimport { warn } from '../utils/log';\n\ninterface Position extends IBPOSITION {\n    entryDate?: Date; // Date when the position was opened, imaginary when ibkr sees position first.\n}\n\nexport class Portfolios {\n    ib: IBApiNext;\n    private static _instance: Portfolios;\n\n    private currentPortfolios: Map<number, Position> = new Map();\n    private closedPositions: Map<number, Position> = new Map();\n    private entryPrices: Map<number, number> = new Map();\n    private entryDates: Map<number, Date> = new Map();\n\n    private GetPositions: Subscription;\n\n    public static get Instance(): Portfolios {\n        return this._instance || (this._instance = new this());\n    }\n\n    private constructor() { }\n\n    get positions(): Position[] {\n        return Array.from(this.currentPortfolios.values());\n    }\n\n    updateMarketPrice = (conId: number, close: number): void => {\n        const position = this.currentPortfolios?.get(conId);\n        if (position) {\n            const newPosition = { ...position };\n            newPosition.marketPrice = close;\n            this.currentPortfolios.set(conId, newPosition);\n        }\n    };\n\n    getEntryPrice = (conId: number): number | undefined => {\n        return this.entryPrices.get(conId);\n    }\n\n    getEntryDate = (conId: number): Date | undefined => {\n        return this.entryDates.get(conId);\n    }\n\n    getLatestClosedPosition(conId: number): Position | undefined {\n        return this.closedPositions.get(conId);\n    }\n\n    mapPositions = (positionOg: Position, subscribe = false): Position => {\n        if (!positionOg) {\n            return;\n        }\n\n        let position: any = { ...positionOg };\n\n        const contractId = position?.contract?.conId;\n        if (contractId) {\n            if (position.contract.exchange === \"VALUE\") {\n                return;\n            }\n\n            if (!position.pos) {\n                const positionToClose = this.currentPortfolios.get(contractId);\n                if (positionToClose) {\n                    this.closedPositions.set(contractId, positionToClose);\n                    this.currentPortfolios.delete(contractId);\n                    this.entryPrices.delete(contractId);\n                    this.entryDates.delete(contractId);\n                    logPosition(\"Portfolios.mapPositions\", positionToClose, true);\n                }\n            } else {\n                // TODO: use this.entryDates or position.entryDate\n                position.entryDate = new Date();\n                const multiplier = position.contract.multiplier;\n                if (multiplier) {\n                    position.avgCost = position.avgCost / multiplier;\n                }\n\n                this.currentPortfolios.set(contractId, position);\n                this.entryPrices.set(contractId, position.avgCost);\n                this.entryDates.set(contractId, position.entryDate);\n\n                if (this.closedPositions.has(contractId)) {\n                    this.closedPositions.delete(contractId);\n                }\n\n                // When successful\n                if (subscribe) {\n                    const isBuy = position.pos > 0;\n                    const whatToShow = isBuy ? WhatToShow.ASK : WhatToShow.BID;\n                    const barSize = \"5 secs\";\n                    MarketDataManager.Instance.getHistoricalDataUpdates(position.contract, barSize as BarSizeSetting, whatToShow);\n                }\n                logPosition(\"Portfolios.mapPositions\", position);\n            }\n\n        }\n        return position\n    }\n\n    /**\n     * getPortfolios \n     */\n    asyncPortfolios = async (): Promise<Position[]> => {\n        const getPositions = await firstValueFrom(this.ib.getPositions());\n        let positions: Position[] = [];\n        getPositions.all.forEach((value, key) => {\n            positions = compact(value.map((position) => this.mapPositions(position)));\n        });\n\n        return positions;\n    }\n\n    syncPortfolios = (): void => {\n        MarketDataManager.Instance.init();\n        this.GetPositions = this.ib.getPositions()\n        \n        .pipe(\n            catchError((error) => {\n                warn(`syncPortfolios`, `Error subscribing to positions`, error);\n                return of(null);\n            })\n        )\n        .subscribe((accountUpdates) => {\n            accountUpdates.all.forEach((value, key) => {\n                value.forEach((position) => this.mapPositions(position));\n            });\n        });\n    }\n\n    disconnect = () => {\n        this.GetPositions.unsubscribe();\n    }\n\n    getPositions = async (): Promise<Position[]> => {\n        return this.asyncPortfolios();\n    }\n\n    init = (): void => {\n        if (!this.ib) {\n            this.ib = IBKRConnection.Instance.ib;\n            this.syncPortfolios();\n        }\n    };\n\n}\n\nexport default Portfolios;\n"]}