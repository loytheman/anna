{"version":3,"file":"Orders.js","sourceRoot":"","sources":["../../src/orders/Orders.ts"],"names":[],"mappings":"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","sourcesContent":["import { Subscription, catchError, firstValueFrom, of } from 'rxjs';\nimport { IBApiNext, OpenOrder, Order, Contract, OrderCancel, OrderStatus, OrderType } from '@stoqey/ib';\nimport IBKRConnection from '../connection/IBKRConnection';\nimport compact from 'lodash/compact';\nimport identity from 'lodash/identity';\nimport omit from 'lodash/omit';\nimport pickBy from 'lodash/pickBy';\nimport { log, warn } from '../utils/log';\nimport awaitP from '../utils/awaitP';\nimport { Instrument, Trade as SSTrade, OrderAction as SsOrderAction } from '../interfaces';\nimport Portfolios from '../portfolios/Portfolios';\nimport { ContractInstrument } from '../marketdata/MarketDataManager';\nimport { getSymbolKey } from '../utils/instrument.utils';\nimport { Mutex } from 'async-mutex';\nimport { logOrder } from '../utils/log.utils';\nimport { IBKREvents, IBKREVENTS } from '../events';\n\nconst ibkrEvents = IBKREvents.Instance;\nexport class Orders {\n    ib: IBApiNext = null;\n\n    private GetOrders: Subscription;\n\n    private openOrders: Map<number, OpenOrder> = new Map();\n    private cancelledOrders: Map<number, OpenOrder> = new Map();\n\n    private completedTrades: Map<number, SSTrade> = new Map();\n\n    private openOrderQueue: OpenOrder[] = [];\n\n    mutex = new Mutex();\n\n    private static _instance: Orders;\n\n    public static get Instance(): Orders {\n        return this._instance || (this._instance = new this());\n    }\n\n    private constructor() {\n    }\n\n    get orders(): OpenOrder[] {\n        return Array.from(this.openOrders.values());\n    }\n\n    get trades(): SSTrade[] {\n        return Array.from(this.completedTrades.values());\n    }\n\n    /**\n     * getOrders\n     */\n    getOrders = (): Promise<OpenOrder[]> => {\n        return this.asyncOpenOrders();\n    }\n\n    logOpenOrder = (title: string, openOrder: OpenOrder) => {\n        try {\n            const { contract, order } = openOrder;\n            const symbol = getSymbolKey(contract);\n            const { permId = \"\", action = \"\", totalQuantity = 0, orderType = \"\", lmtPrice, auxPrice } = order || {} as any;\n            const avgFillPrice = openOrder.orderStatus?.avgFillPrice;\n            const status = openOrder.orderStatus?.status;\n            // TODO: Print order price based on type since stop-market orders have `lmtPrice: 0` and limit orders have `auxPrice: 0` (which is valid for options though).\n            log(`Orders.${title} symbol=${symbol} permId=${permId}`, `${action} ${totalQuantity} ${orderType} @${avgFillPrice ?? lmtPrice ?? auxPrice ?? 0} => ${status}`);\n        }\n        catch (error) {\n        }\n    };\n\n    processOrderQueue = async () => {\n        const portfoliosManager = Portfolios.Instance;\n        await portfoliosManager.init();\n\n        await this.mutex.runExclusive(async () => {\n            while (this.openOrderQueue.length > 0) {\n                const order = this.openOrderQueue.shift();\n                const contractId = order?.contract?.conId;\n                const permId = order?.order?.permId;\n\n                // Ignore if already Filled processed / completed\n                if (this.completedTrades.has(permId)) {\n                    continue;\n                };\n\n                // Ignore cancelled orders\n                if (this.cancelledOrders.has(permId)) {\n                    continue;\n                }\n\n                this.logOpenOrder(\"processOrderQueue\", order);\n\n                const orderStatus = order.orderState?.status || order.orderStatus?.status;\n\n                // log(`Orders.syncOpenOrders`, `Order ${order.permId} for contract ${orderStatus}`);\n                switch (orderStatus) {\n                    case OrderStatus.Filled:\n\n                        const entryPrice =\n                            portfoliosManager.getEntryPrice(contractId) ?? //  \n                            portfoliosManager.getLatestClosedPosition(contractId)?.avgCost ??\n                            order.orderStatus.avgFillPrice;\n\n                        const entryDate =\n                            portfoliosManager.getEntryDate(contractId) ??\n                            portfoliosManager.getLatestClosedPosition(contractId)?.entryDate ??\n                            new Date(); // for new positions\n\n                        const trade: SSTrade = {\n                            id: `${order.order.orderId}`,\n                            instrument: order.contract as Instrument,\n                            entryPrice,\n                            entryDate,\n                            type: order.order.orderType as any,\n                            price: order.orderStatus.avgFillPrice,\n                            quantity: order.order.totalQuantity,\n                            action: order.order.action as SsOrderAction,\n                            date: new Date()\n                        };\n\n                        if (!this.completedTrades.has(permId)) {\n                            this.completedTrades.set(permId, trade);\n                            ibkrEvents.emit(IBKREVENTS.IBKR_SAVE_TRADE, trade);\n                        }\n\n                        this.openOrders.delete(permId);\n\n                        break;\n                    case OrderStatus.ApiCancelled:\n                    case OrderStatus.Cancelled:\n                        this.openOrders.delete(permId);\n                        this.cancelledOrders.set(permId, order);\n                    \n                        break;\n                    case OrderStatus.Inactive:\n                    case OrderStatus.PendingCancel:\n                    case OrderStatus.PendingSubmit:\n                    case OrderStatus.ApiPending:\n                    case OrderStatus.Unknown:\n                    case OrderStatus.PreSubmitted:\n                    case OrderStatus.Submitted:\n                        this.openOrders.set(permId, order);\n\n                        break;\n                    default:\n\n                        break;\n                }\n              \n            }\n        });\n    }\n\n    /**\n     * getOpenOrders\n     */\n    asyncOpenOrders = async (): Promise<OpenOrder[]> => {\n        const openOrders = await firstValueFrom(this.ib.getOpenOrders());\n\n        const orders: OpenOrder[] = compact(openOrders.all.map((order) => {\n            if (!order) {\n                return;\n            }\n            this.openOrderQueue.push(order);\n            return order;\n        }));\n\n        await this.processOrderQueue();\n\n        return orders;\n    }\n\n    syncOpenOrders = (): void => {\n        const portfoliosManager = Portfolios.Instance;\n        portfoliosManager.init();\n\n        this.GetOrders = this.ib.getAutoOpenOrders(true)\n        .pipe(\n            catchError((error) => {\n                warn(`syncOpenOrders`, `Error subscribing to open orders`, error);\n                return of(null);\n            })\n        )\n        .subscribe((openOrders) => {\n            openOrders.all.forEach((order) => {\n                if (!order) {\n                    return;\n                }\n                this.openOrderQueue.push(order);\n            });\n            this.processOrderQueue();\n        });\n    }\n\n    /**\n     * init\n     */\n    public init = async (): Promise<void> => {\n        const self = this;\n\n        if (!self.ib) {\n            const ib = IBKRConnection.Instance.ib;\n            self.ib = ib;\n\n            this.syncOpenOrders();\n        }\n    };\n\n    parseOrder = (orderPlaced: Order, contractDetails: ContractInstrument): { order: Order, contract: Contract } => {\n        if (contractDetails?.minTick) {\n            if (orderPlaced?.orderType === OrderType.STP_LMT || orderPlaced?.orderType === OrderType.LMT) {\n                if (orderPlaced?.lmtPrice) {\n                    orderPlaced.lmtPrice = Number((Math.round(orderPlaced.lmtPrice / contractDetails.minTick) * contractDetails.minTick).toFixed(2));\n                }\n            }\n            else {\n                delete orderPlaced.lmtPrice;\n            }\n\n            if (orderPlaced?.auxPrice) {\n                orderPlaced.auxPrice = Number((Math.round(orderPlaced.auxPrice / contractDetails.minTick) * contractDetails.minTick).toFixed(2));\n            }\n        };\n\n        const contract = pickBy(omit(contractDetails.contract, [\"primaryExch\"]), identity);\n\n        const order = pickBy(orderPlaced, identity);\n\n        return { order, contract };\n    }\n\n    /**\n     * placeOrder\n     */\n    placeOrder = async (contractDetails: ContractInstrument, orderToPlace: Order): Promise<boolean> => {\n\n        const { order, contract } = this.parseOrder(orderToPlace, contractDetails);\n        logOrder(`Orders.placeOrder Placing order ${order.orderId || \"\"}`, { order, contract });\n\n        const [orderPlaced, error] = await awaitP(this.ib.placeNewOrder(contractDetails, order));\n        if (error) {\n            logOrder(`Orders.placeOrder Error placing order ${error}`, { order, contract }, true);\n            return;\n        }\n        if (orderPlaced) {\n            // TODO save order tick, entry\n            logOrder(`Orders.placeOrder Order placed id=${orderPlaced || order.orderId}`, { order, contract });\n            return true;\n        }\n        logOrder(`Orders.placeOrder Order NOT placed ${order.orderId || \"\"}`, { order, contract }, true);\n        return false;\n    }\n\n    /**\n     * modifyOrder\n     */\n    modifyOrder = async (id: number, contractDetails: ContractInstrument, orderToPlace: Order): Promise<boolean> => {\n        try {\n            const { order, contract } = this.parseOrder(orderToPlace, contractDetails);\n            this.ib.modifyOrder(id, contractDetails, order)\n            // TODO save order tick, entry\n            logOrder(`Orders.modifyOrder ${id}`, { order, contract });\n            return true;\n        }\n        catch (e) {\n            log(`Orders.modifyOrder`, `Error modifying order ${id}`);\n            return false;\n        }\n    }\n\n    cancelOrder = async (orderId: number, orderCancel?: string | OrderCancel): Promise<boolean> => {\n        try {\n            this.ib.cancelOrder(orderId, orderCancel)\n            // TODO save order tick, entry\n            log(`Orders.cancelOrder`, `Order cancelled ${orderId}`);\n            return true;\n        }\n        catch (e) {\n            log(`Orders.cancelOrder`, `Error modifying order ${orderId}`);\n            return false;\n        }\n    }\n\n    cancelAllOrders = async (orderCancel: OrderCancel): Promise<boolean> => {\n        try {\n            this.ib.cancelAllOrders(orderCancel);\n            // TODO save order tick, entry\n            log(`Orders.cancelAllOrders`, `Order placed ${orderCancel}`);\n            return true;\n        }\n        catch (e) {\n            log(`Orders.cancelAllOrders`, `Error modifying order ${orderCancel}`);\n            return false;\n        }\n    }\n\n\n}\n\nexport default Orders;"]}